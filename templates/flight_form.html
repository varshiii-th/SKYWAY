{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flight Booking</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f4f4;
    }

    h2 {
      color: #007BFF;
    }

    form label {
      margin-right: 10px;
      font-weight: bold;
    }

    input[type="text"],
    input[type="date"] {
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-right: 10px;
    }

    button {
      padding: 8px 14px;
      background-color: #007BFF;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background-color: #0056b3;
    }

    .flight-card {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 15px;
      background: #fff;
      border-radius: 6px;
    }

    .flight-card h3 {
      margin-top: 0;
      color: #333;
    }

    .flight-card p {
      margin: 5px 0;
      color: #555;
    }

    .seat-btn {
      background-color: #28a745;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .seat-btn:hover {
      background-color: #218838;
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 500;
    }

    #seatModal {
      display: none;
      position: fixed;
      top: 15%;
      left: 30%;
      width: 40%;
      max-height: 70%;
      background: white;
      border: 2px solid #000;
      padding: 20px;
      overflow: hidden;
      z-index: 1000;
      box-shadow: 0 0 10px rgba(0,0,0,0.6);
      border-radius: 8px;
    }

    #seat-grid-wrapper {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }

    #seat-grid {
      display: grid;
      grid-template-columns: repeat(5, 60px);
      gap: 10px;
    }

    #seat-grid button {
      height: 40px;
      border-radius: 5px;
      border: none;
      background: lightgray;
      cursor: pointer;
      font-weight: bold;
    }

    #seat-grid button:disabled {
      background: red;
      color: white;
      cursor: not-allowed;
    }

    #seat-grid button.selected {
      background: green;
      color: white;
    }

    .messages {
      margin-top: 20px;
    }

    .messages li {
      list-style: none;
      margin: 5px 0;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
    }

    .messages li.success {
      background-color: #d4edda;
      color: #155724;
    }

    .messages li.error {
      background-color: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>

<a href="{% url 'logout' %}">Logout</a>

<h2>Search Flights</h2>
<form method="POST">
  {% csrf_token %}
  <label>Origin:
    <input type="text" name="origin">
  </label>
  <label>Destination:
    <input type="text" name="destination">
  </label>
  <label>Departure Date:
    <input type="date" name="departure_date">
  </label>
  <button type="submit">Filter</button>
</form>

<hr>

<h2>{% if request.method == "POST" %}Filtered{% else %}All{% endif %} Flights</h2>

{% if flights %}
  {% for flight in flights %}
    <div class="flight-card">
      <h3>{{ flight.origin }} → {{ flight.destination }}</h3>
      <p>Date: {{ flight.departure_date }} | Time: {{ flight.departure_time }} → {{ flight.arrival_time }}</p>
      <p>Price: ₹{{ flight.price }}</p>
      <p>Seats Available: {{ flight.seats_available|length }}</p>

      <button
        class="seat-btn"
        data-flight-id="{{ flight.id }}"
        data-seat-id="seatmap-{{ flight.id }}">
        View Seats
      </button>
    </div>

    <!-- Safe JSON seat data -->
    <script type="application/json" id="seatmap-{{ flight.id }}">
      {{ flight.seat_map_json|safe }}
    </script>
  {% endfor %}
{% else %}
  <p>No flights available.</p>
{% endif %}

<!-- Modal Overlay -->
<div class="overlay" id="overlay" onclick="closeSeatModal()"></div>

<!-- Seat Modal -->
<div id="seatModal">
  <form method="POST" action="{% url 'book_seat' %}">
    {% csrf_token %}
    <input type="hidden" name="flight_id" id="flight_id">
    <input type="hidden" name="seat_number" id="seat_number">

    <h3>Select a Seat</h3>
    <div id="seat-grid-wrapper">
      <div id="seat-grid"></div>
    </div>

    <label>Your Name:
      <input type="text" name="user_name" required>
    </label><br><br>
<label>Meal Preference:
  <select name="meal_choice" required>
    <option value="Veg">Vegetarian</option>
    <option value="Non-Veg">Non-Vegetarian</option>
    <option value="Jain">Jain Meal</option>
    <option value="No Meal">No Meal</option>
  </select>
</label><br><br>
    <button type="submit">Book</button>
    <button type="button" onclick="closeSeatModal()">Cancel</button>
  </form>
</div>

<!-- Message Feedback -->
{% if messages %}
  <ul class="messages">
    {% for message in messages %}
      <li class="{{ message.tags }}">{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}

<script>
  function openSeatModal(flightId, seatMap) {
    document.getElementById('overlay').style.display = 'block';
    document.getElementById('seatModal').style.display = 'block';
    document.getElementById('flight_id').value = flightId;

    const seatGrid = document.getElementById('seat-grid');
    seatGrid.innerHTML = '';
    document.getElementById('seat_number').value = '';

    seatMap.forEach(seat => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.innerText = seat.name;

      if (seat.booked) {
        btn.disabled = true;
      } else {
        btn.onclick = () => {
          document.getElementById('seat_number').value = seat.name;
          document.querySelectorAll('#seat-grid button').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
        };
      }

      seatGrid.appendChild(btn);
    });
  }

  function closeSeatModal() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('seatModal').style.display = 'none';
  }

  document.querySelectorAll('.seat-btn').forEach(button => {
    button.addEventListener('click', function () {
      const flightId = this.dataset.flightId;
      const seatId = this.dataset.seatId;
      const seatData = document.getElementById(seatId).textContent.trim();
      if (!seatData) {
        alert("Seat data not found or empty.");
        return;
      }

      try {
        const seatMap = JSON.parse(seatData);
        openSeatModal(flightId, seatMap);
      } catch (e) {
        alert("Invalid seat data format.");
        console.error("Parse error:", e);
      }
    });
  });
</script>

</body>
</html>
